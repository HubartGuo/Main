<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户文档中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            padding: 40px;
            text-align: center;
        }

            .header h1 {
                font-size: 2.8rem;
                margin-bottom: 10px;
                font-weight: 700;
            }

            .header p {
                font-size: 1.2rem;
                opacity: 0.9;
            }

        .content {
            padding: 40px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

            .search-box input {
                width: 100%;
                padding: 16px 20px 16px 50px;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 1rem;
                transition: all 0.3s ease;
            }

                .search-box input:focus {
                    outline: none;
                    border-color: #4f46e5;
                    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
                }

            .search-box i {
                position: absolute;
                left: 18px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
            }

        .search-info {
            margin-bottom: 20px;
            padding: 12px 15px;
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            display: none;
        }

        .tree-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            min-height: 500px;
        }

        .tree-item {
            padding: 10px 5px;
            border-bottom: 1px solid #f3f4f6;
            line-height: 1.8;
            transition: background-color 0.2s;
        }

            .tree-item:hover {
                background-color: #f9fafb;
            }

        .item-content {
            display: flex;
            align-items: center;
            min-height: 30px;
        }

        .toggle-icon {
            width: 24px;
            text-align: center;
            margin-right: 5px;
            color: #6b7280;
            font-size: 0.9rem;
            cursor: pointer;
            flex-shrink: 0;
        }

        .item-icon {
            width: 20px;
            text-align: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .folder .item-icon {
            color: #f59e0b;
        }

        .file .item-icon {
            color: #6b7280;
        }

        .file.pdf .item-icon {
            color: #ef4444;
        }

        .file.txt .item-icon {
            color: #10b981;
        }

        .item-name {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-link {
            text-decoration: none;
            color: #111827;
            display: block;
            width: 100%;
        }

            .file-link:hover {
                color: #4f46e5;
                text-decoration: underline;
            }

        .item-size {
            color: #6b7280;
            font-size: 0.85rem;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .level-0 {
            padding-left: 0;
        }

        .level-1 {
            padding-left: 24px;
        }

        .level-2 {
            padding-left: 48px;
        }

        .level-3 {
            padding-left: 72px;
        }

        .level-4 {
            padding-left: 96px;
        }

        .level-5 {
            padding-left: 120px;
        }

        .search-highlight {
            background-color: #ffeb3b;
            color: #000;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .loading, .empty-state, .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

            .loading i {
                font-size: 2rem;
                margin-bottom: 15px;
                color: #4f46e5;
            }

            .empty-state i {
                font-size: 3rem;
                margin-bottom: 20px;
                color: #9ca3af;
            }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .header {
                padding: 30px 20px;
            }

                .header h1 {
                    font-size: 2.2rem;
                }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-folder-tree"></i> 客户文档中心</h1>
            <p>树形结构浏览 · 智能精准搜索</p>
        </div>
        <div class="content">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="输入文件或文件夹名称进行搜索...">
            </div>
            <div id="searchInfo" class="search-info"></div>
            <div class="tree-container">
                <div id="treeRoot"></div>
            </div>
        </div>
    </div>

    <script>
        // 全局状态
        let appState = { treeData: null, currentSearch: '', activeMatches: [] };

        // 工具函数
        function getFileIcon(fileType) {
            const icons = { '.pdf': 'fas fa-file-pdf', '.txt': 'fas fa-file-alt', '.jpg': 'fas fa-file-image', '.jpeg': 'fas fa-file-image', '.png': 'fas fa-file-image', '.docx': 'fas fa-file-word', '.xlsx': 'fas fa-file-excel', '.pptx': 'fas fa-file-powerpoint', 'folder': 'fas fa-folder', 'default': 'fas fa-file' };
            return icons[fileType] || icons.default;
        }
        function formatFileSize(bytes) { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i]; }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        // 主渲染函数
        function renderTree() {
            const container = document.getElementById('treeRoot');
            if (!appState.treeData) {
                container.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>正在加载文档树...</p></div>`;
                return;
            }
            container.innerHTML = '';
            if (!appState.currentSearch) {
                renderTreeNode(appState.treeData, container, 0);
            } else {
                if (appState.activeMatches.length === 0) {
                    container.innerHTML = `<div class="no-results"><i class="fas fa-search"></i><h3>未找到匹配项</h3><p>没有找到包含 "<strong>${escapeHtml(appState.currentSearch)}</strong>" 的文件或文件夹</p></div>`;
                } else {
                    // 【修复点】调用新的函数来渲染搜索结果
                    renderSearchResultsList();
                }
            }
        }

        // 渲染普通树节点
        function renderTreeNode(node, parentElement, level) {
            if (!node.children) return;
            const sortedChildren = [...node.children].sort((a, b) => b.isFolder - a.isFolder || a.name.localeCompare(b.name, 'zh-CN'));
            sortedChildren.forEach(child => {
                const itemEl = document.createElement('div');
                const levelClass = `level-${Math.min(level, 5)}`;
                itemEl.className = `tree-item ${child.isFolder ? 'folder' : 'file'} ${levelClass}`;
                const iconClass = getFileIcon(child.isFolder ? 'folder' : child.fileType);
                let html = `<div class="item-content">`;
                if (child.isFolder) {
                    html += `<div class="toggle-icon" onclick="toggleFolder(this)"><i class="fas fa-chevron-right"></i></div>
                                 <div class="item-icon"><i class="${iconClass}"></i></div>
                                 <div class="item-name">${escapeHtml(child.name)}</div>`;
                } else {
                    // 【重要】标准文件链接生成方式
                    html += `<div class="toggle-icon" style="visibility:hidden;"><i class="fas fa-chevron-right"></i></div>
                                 <div class="item-icon"><i class="${iconClass}"></i></div>
                                 <div class="item-name">
                                    <a href="/api/Documents/download/${encodeURIComponent(child.path)}" target="_blank" class="file-link">${escapeHtml(child.name)}</a>
                                 </div>
                                 <div class="item-size">${formatFileSize(child.size)}</div>`;
                }
                html += `</div>`;
                itemEl.innerHTML = html;
                parentElement.appendChild(itemEl);
                if (child.isFolder && child.children && child.children.length > 0) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'tree-children';
                    childrenContainer.style.display = 'none';
                    itemEl.appendChild(childrenContainer);
                    renderTreeNode(child, childrenContainer, level + 1);
                }
            });
        }

        // 【新功能】渲染搜索结果列表（替代之前有问题的渲染方式）
        function renderSearchResultsList() {
            const container = document.getElementById('treeRoot');
            appState.activeMatches.forEach(match => {
                const itemEl = document.createElement('div');
                itemEl.className = `tree-item ${match.isFolder ? 'folder' : 'file'} level-1`;

                const iconClass = getFileIcon(match.isFolder ? 'folder' : match.node.fileType);
                const pathParts = match.path.split('/').filter(p => p);
                const displayPath = pathParts.length > 1 ? pathParts.slice(0, -1).join(' / ') + ' / ' : '';

                let html = `<div class="item-content">`;
                html += `<div class="item-icon"><i class="${iconClass}"></i></div>`;
                html += `<div class="item-name">`;

                if (match.isFolder) {
                    // 文件夹只显示名称和路径
                    html += `<span style="color:#6b7280; font-size:0.9em">${escapeHtml(displayPath)}</span>${escapeHtml(match.node.name)}`;
                } else {
                    // 【关键修复】文件：创建正确的可点击链接
                    // 使用 match.node.path 作为参数，这是后端需要的完整相对路径
                    const fileUrl = `/api/Documents/download/${encodeURIComponent(match.node.path)}`;
                    html += `<span style="color:#6b7280; font-size:0.9em">${escapeHtml(displayPath)}</span>
                                 <a href="${fileUrl}" target="_blank" class="file-link">${escapeHtml(match.node.name)}</a>`;
                }

                html += `</div>`;
                if (!match.isFolder) {
                    html += `<div class="item-size">${formatFileSize(match.node.size)}</div>`;
                }
                html += `</div>`;
                itemEl.innerHTML = html;
                container.appendChild(itemEl);
            });
        }

        // 搜索功能
        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim().toLowerCase();
            const searchInfoEl = document.getElementById('searchInfo');

            appState.currentSearch = searchTerm;
            searchInfoEl.style.display = 'none';
            if (!appState.treeData) return;

            if (!searchTerm) {
                appState.activeMatches = [];
                renderTree();
                return;
            }

            const matches = [];
            function searchInNode(node, nodePath) {
                let hasMatchInSubtree = false;
                const isMatch = node.name.toLowerCase().includes(searchTerm);
                if (isMatch) {
                    matches.push({ node: node, path: nodePath, isFolder: node.isFolder });
                    hasMatchInSubtree = true;
                }
                if (node.children) {
                    node.children.forEach(child => {
                        const childPath = nodePath + '/' + child.name;
                        if (searchInNode(child, childPath)) {
                            hasMatchInSubtree = true;
                        }
                    });
                }
                return hasMatchInSubtree;
            }
            searchInNode(appState.treeData, '');
            appState.activeMatches = matches;

            if (searchTerm && matches.length > 0) {
                const folderCount = matches.filter(m => m.isFolder).length;
                const fileCount = matches.filter(m => !m.isFolder).length;
                searchInfoEl.innerHTML = `找到 <strong>${matches.length}</strong> 个匹配 "<strong>${escapeHtml(searchTerm)}</strong>" 的结果
                        <span style="font-size:0.9em; color:#6b7280; margin-left:10px;">${folderCount} 个文件夹, ${fileCount} 个文件</span>`;
                searchInfoEl.style.display = 'block';
            }
            renderTree();
        }

        // 交互功能
        function toggleFolder(toggleIcon) {
            const itemEl = toggleIcon.closest('.tree-item');
            const childrenContainer = itemEl.querySelector('.tree-children');
            const icon = toggleIcon.querySelector('i');
            if (childrenContainer.style.display === 'none') {
                childrenContainer.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            } else {
                childrenContainer.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            }
        }

        // 数据加载
        async function loadDocumentTree() {
            try {
                const response = await fetch('/api/Documents/tree');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                appState.treeData = await response.json();
                renderTree();
            } catch (error) {
                console.error('加载失败:', error);
                document.getElementById('treeRoot').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>无法加载文档树</h3>
                            <p>请检查：1) 后端是否运行；2) 接口 /api/Documents/tree 是否可用</p>
                            <button onclick="loadDocumentTree()" style="margin-top:20px; padding:10px 20px; background:#4f46e5; color:white; border:none; border-radius:8px; cursor:pointer;">
                                <i class="fas fa-redo"></i> 重新加载
                            </button>
                        </div>`;
            }
        }

        // 事件监听与初始化
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 300);
            });
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    performSearch();
                }
            });
            loadDocumentTree();
        });
    </script>
</body>
</html>


<!--<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户文档中心 - 树形视图</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .search-box {
            position: relative;
            margin-bottom: 30px;
        }
        .search-box input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .search-box input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .search-box i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        .tree-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            min-height: 400px;
        }
        /* 树形结构样式 */
        .tree-node {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .tree-item {
            padding: 8px 5px;
            border-bottom: 1px solid #f3f4f6;
            line-height: 1.8;
        }
        .tree-item:hover {
            background-color: #f9fafb;
        }
        .item-content {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .toggle-icon {
            width: 20px;
            text-align: center;
            margin-right: 5px;
            color: #6b7280;
            font-size: 0.8rem;
        }
        .toggle-icon:hover {
            color: #4f46e5;
        }
        .item-icon {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .folder .item-icon {
            color: #f59e0b; /* 文件夹橙色 */
        }
        .file .item-icon {
            color: #6b7280; /* 文件灰色 */
        }
        .file.pdf .item-icon { color: #ef4444; } /* PDF红色 */
        .file.txt .item-icon { color: #10b981; } /* 文本绿色 */
        .file.img .item-icon { color: #8b5cf6; } /* 图片紫色 */
        .item-name {
            flex-grow: 1;
        }
        .file-link {
            text-decoration: none;
            color: #111827;
        }
        .file-link:hover {
            color: #4f46e5;
            text-decoration: underline;
        }
        .item-size {
            color: #6b7280;
            font-size: 0.9rem;
            margin-left: 15px;
        }
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #4f46e5;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #9ca3af;
        }
        .search-highlight {
            background-color: #ffeb3b; /* 明亮的黄色背景 */
            color: #333;
            font-weight: bold;
            padding: 1px 3px;
            border-radius: 3px;
        }

        #searchStats {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            display: none;
        }

        /* 缩进类，用于表示层级 */
        .level-1 { padding-left: 20px; }
        .level-2 { padding-left: 40px; }
        .level-3 { padding-left: 60px; }
        .level-4 { padding-left: 80px; }
        .level-5 { padding-left: 100px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-folder-tree"></i> 客户文档中心</h1>
            <p></p>
        </div>
        <div class="content">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="输入关键词搜索文件或文件夹..." onkeyup="handleSearchInput(event)">
            </div>
            <div class="tree-container">
                <div id="treeRoot"></div>
            </div>
        </div>
    </div>

    <script>
        // 获取文件图标类名
        function getFileIconClass(fileType) {
            const iconMap = {
                '.pdf': 'fas fa-file-pdf',
                '.txt': 'fas fa-file-alt',
                '.jpg': 'fas fa-file-image',
                '.jpeg': 'fas fa-file-image',
                '.png': 'fas fa-file-image',
                '.docx': 'fas fa-file-word',
                '.xlsx': 'fas fa-file-excel',
                '.pptx': 'fas fa-file-powerpoint',
                'folder': 'fas fa-folder',
                'default': 'fas fa-file'
            };
            // 如果是文件夹，返回 folder，否则返回对应的图标或默认图标
            if (fileType === 'folder') {
                return iconMap.folder;
            }
            return iconMap[fileType] || iconMap.default;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 主函数：加载文档树
        async function loadDocumentTree() {
            const treeRootEl = document.getElementById('treeRoot');
            treeRootEl.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载文档树...</p>
                </div>
            `;
            try {
                //const response = await fetch('/api/Documents/tree');
                //if (!response.ok) {
                //    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                //}
                //const treeData = await response.json();
                //treeRootEl.innerHTML = ''; // 清空加载提示
                //// 开始递归渲染，从根节点（treeData）开始，层级为0
                //renderTreeItem(treeData, treeRootEl, 0);
                const response = await fetch('/api/Documents/tree');
                if (!response.ok) throw new Error(`HTTP错误! 状态码: ${response.status}`);
                globalTreeData = await response.json(); // <-- 存入全局变量
                treeRootEl.innerHTML = '';
                renderTreeItem(globalTreeData, treeRootEl, 0); // 初始渲染
                // 如果之前有搜索词，重新应用搜索（例如页面刷新后保持状态）
                if (lastSearchKeyword) {
                    performTreeSearch(lastSearchKeyword);
                }
            } catch (error) {
                console.error('加载文档树失败:', error);
                treeRootEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>无法加载文档树</h3>
                        <p>请检查网络连接或联系管理员</p>
                        <button onclick="loadDocumentTree()" style="margin-top: 20px; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-redo"></i> 重新加载
                        </button>
                    </div>
                `;
            }
        }

        // 核心函数：递归渲染一个树节点及其子节点
        function renderTreeItem(node, parentElement, level) {
            // 1. 为当前节点创建容器
            const nodeContainer = document.createElement('div');
            nodeContainer.className = `tree-node level-${Math.min(level, 5)}`; // 限制最大缩进
            parentElement.appendChild(nodeContainer);

            // 2. 如果当前节点有子节点（Children），则遍历它们
            if (node.children && node.children.length > 0) {
                // 先按文件夹在前、文件在后排序
                const sortedChildren = node.children.sort((a, b) => {
                    if (a.isFolder === b.isFolder) {
                        return a.name.localeCompare(b.name);
                    }
                    return b.isFolder - a.isFolder; // 文件夹为true(1)在前
                });

                // 遍历每个子项（可能是文件夹或文件）
                sortedChildren.forEach(child => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `tree-item ${child.isFolder ? 'folder' : 'file'} ${child.fileType ? 'file ' + child.fileType.replace('.', '') : ''}`;

                    const itemContentEl = document.createElement('div');
                    itemContentEl.className = 'item-content';

                    // 构建左侧图标和名称区域
                    let iconHtml = '';
                    if (child.isFolder) {
                        // 文件夹：可点击的展开/折叠图标 + 文件夹图标
                        iconHtml = `
                            <span class="toggle-icon" onclick="toggleFolder(this)">
                                <i class="fas fa-chevron-right"></i>
                            </span>
                            <span class="item-icon">
                                <i class="${getFileIconClass('folder')}"></i>
                            </span>
                            <span class="item-name folder-name">${child.name}</span>
                        `;
                    } else {
                        // 文件：空白占位（为了对齐）+ 文件图标 + 可点击的链接
                        iconHtml = `
                            <span class="toggle-icon" style="visibility: hidden;"><i class="fas fa-chevron-right"></i></span>
                            <span class="item-icon">
                                <i class="${getFileIconClass(child.fileType)}"></i>
                            </span>
                            <span class="item-name">
                                <a href="/api/Documents/download/${encodeURIComponent(child.path)}"
                                   target="_blank"
                                   class="file-link">${child.name}</a>
                            </span>
                            <span class="item-size">${formatFileSize(child.size)}</span>
                        `;
                    }
                    itemContentEl.innerHTML = iconHtml;
                    itemEl.appendChild(itemContentEl);
                    nodeContainer.appendChild(itemEl);

                    // 如果是文件夹，为其创建子容器，并递归渲染其子项
                    if (child.isFolder && child.children && child.children.length > 0) {
                        const childrenContainer = document.createElement('div');
                        childrenContainer.className = 'tree-children';
                        childrenContainer.style.display = 'none'; // 初始状态为折叠
                        itemEl.appendChild(childrenContainer);
                        // 递归调用！这是实现树形结构的关键
                        renderTreeItem(child, childrenContainer, level + 1);
                    }
                });
            }
        }

        // 切换文件夹展开/折叠状态
        function toggleFolder(toggleIconEl) {
            const childrenContainer = toggleIconEl.closest('.tree-item').querySelector('.tree-children');
            const icon = toggleIconEl.querySelector('i');

            if (childrenContainer.style.display === 'none') {
                // 展开
                childrenContainer.style.display = 'block';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                // 折叠
                childrenContainer.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }

        // 简单的树形内容搜索过滤（根据输入框内容高亮匹配项）
        function filterTree() {
            const filter = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.tree-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = '';
                    // 简单高亮：可以扩展这里，为匹配的文本添加背景色
                } else {
                    item.style.display = 'none';
                }
            });
        }

        / 核心：在整棵树数据中搜索，并标记匹配项和需要展开的路径
        function performTreeSearch(keyword) {
            lastSearchKeyword = keyword;
            if (!globalTreeData) return;

            const searchTerm = keyword.trim().toLowerCase();
            const matches = []; // 存储所有匹配项的路径
            const pathsToExpand = new Set(); // 存储需要展开的文件夹路径（用Set去重）

            // 递归遍历树的辅助函数
            function searchNode(node, nodePath) {
                let isNodeMatch = false;
                let hasChildMatch = false;

                // 检查当前节点名称是否匹配（文件夹或文件）
                if (node.name.toLowerCase().includes(searchTerm)) {
                    isNodeMatch = true;
                    matches.push(nodePath);
                }

                // 递归搜索子节点
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        const childPath = nodePath + '/' + child.name;
                        const childHasMatch = searchNode(child, childPath);
                        if (childHasMatch) {
                            hasChildMatch = true;
                            // 如果子节点有匹配，则当前文件夹路径需要被展开
                            pathsToExpand.add(nodePath);
                        }
                    });
                }

                // 返回当前节点或其后代是否有匹配
                return isNodeMatch || hasChildMatch;
            }

            // 从根节点开始搜索
            searchNode(globalTreeData, '');

            // 调用函数更新UI：展开路径、高亮匹配项
            updateUIToShowSearchResults(pathsToExpand, matches, searchTerm);
            updateSearchStats(matches.length, searchTerm); // 更新搜索结果统计（可选）
        }

        // 更新界面以展示搜索结果：展开路径、高亮文本
        function updateUIToShowSearchResults(pathsToExpand, matchPaths, searchTerm) {
            // 1. 首先，如果有搜索词，强制展开所有需要展示的路径
            if (searchTerm) {
                // 遍历所有树项，收起所有文件夹（提供一个干净的初始状态）
                document.querySelectorAll('.tree-children').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.toggle-icon i').forEach(icon => {
                    icon.className = 'fas fa-chevron-right';
                });

                // 展开包含匹配项的路径
                pathsToExpand.forEach(path => {
                    expandPathToShowItem(path);
                });
            } else {
                // 如果没有搜索词（清空搜索框），移除所有高亮，恢复默认折叠状态（或你想要的默认状态）
                clearHighlights();
                // 可以选择这里添加逻辑恢复到用户之前的折叠/展开状态，但需要额外记录，这里先简单处理
            }

            // 2. 高亮所有匹配的文本
            highlightMatches(matchPaths, searchTerm);

            // 3. 如果有匹配项，滚动到第一个匹配项附近
            if (matchPaths.length > 0) {
                scrollToFirstMatch();
            }
        }

        // 展开到特定路径的函数
        function expandPathToShowItem(itemPath) {
            const pathSegments = itemPath.split('/').filter(s => s);
            let currentSelector = '#treeRoot';

            // 遍历路径的每一段，模拟点击展开
            pathSegments.forEach(segment => {
                // 找到当前层级中名称匹配的文件夹项（注意：名称可能重复，这里简化处理）
                const itemEl = document.querySelector(`${currentSelector} .tree-item .folder-name`);
                // 这里需要更精确的查找，实际中可能需要遍历同级的.item-content
                // 找到后，触发其父元素中.toggle-icon的点击事件
                const toggleIcon = itemEl?.closest('.item-content')?.querySelector('.toggle-icon');
                if (toggleIcon && toggleIcon.querySelector('i').classList.contains('fa-chevron-right')) {
                    toggleIcon.click(); // 模拟点击以展开
                }
                // 更新选择器以进入下一层（这里假设子容器的类名是.tree-children）
                currentSelector += ` .tree-children`;
            });
        }

        // 高亮匹配文本的函数（简单DOM操作版本）
        function highlightMatches(matchPaths, searchTerm) {
            // 先清除之前的高亮
            clearHighlights();

            if (!searchTerm) return;

            // 遍历所有可能包含文本的元素（如.item-name, .folder-name）
            document.querySelectorAll('.item-name, .folder-name').forEach(element => {
                const originalText = element.textContent;
                const lowerText = originalText.toLowerCase();
                const searchLower = searchTerm.toLowerCase();

                if (lowerText.includes(searchLower)) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    const highlighted = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
                    // 注意：如果元素是.folder-name，它是一个span，可以直接设置innerHTML
                    // 如果元素是.item-name且内部有链接，需要更精细的处理，这里简化
                    if (element.classList.contains('folder-name') || !element.querySelector('a')) {
                        element.innerHTML = highlighted;
                    } else {
                        // 对于包含链接的.item-name，我们高亮链接内的文本
                        const link = element.querySelector('a');
                        const linkText = link.textContent;
                        const highlightedLinkText = linkText.replace(regex, '<mark class="search-highlight">$1</mark>');
                        link.innerHTML = highlightedLinkText;
                    }
                }
            });
        }

        function clearHighlights() {
            document.querySelectorAll('.search-highlight').forEach(hl => {
                const parent = hl.parentNode;
                parent.replaceChild(document.createTextNode(hl.textContent), hl);
                parent.normalize(); // 合并相邻的文本节点
            });
        }

        function scrollToFirstMatch() {
            const firstMatch = document.querySelector('.search-highlight');
            if (firstMatch) {
                firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 更新搜索结果统计信息（可选，可以在页面某个地方添加一个<div id="searchStats"></div>）
        function updateSearchStats(matchCount, term) {
            const statsEl = document.getElementById('searchStats');
            if (statsEl) {
                if (term) {
                    statsEl.innerHTML = `找到 <strong>${matchCount}</strong> 个匹配 “<strong>${term}</strong>” 的结果`;
                    statsEl.style.display = 'block';
                } else {
                    statsEl.style.display = 'none';
                }
            }
        }

        // 处理搜索输入，加入防抖优化性能
        let searchTimeout;
        function handleSearchInput(event) {
            clearTimeout(searchTimeout);
            const keyword = event.target.value;

            // 设置防抖延迟，避免每次按键都立即搜索（300毫秒后执行）
            searchTimeout = setTimeout(() => {
                performTreeSearch(keyword);
            }, 300);
        }

        // 页面加载完成后，执行主函数
        document.addEventListener('DOMContentLoaded', loadDocumentTree);
    </script>
</body>
</html>-->
<!--<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户文档中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            padding: 40px;
            text-align: center;
        }

            .header h1 {
                font-size: 2.8rem;
                margin-bottom: 10px;
                font-weight: 700;
            }

            .header p {
                font-size: 1.2rem;
                opacity: 0.9;
            }

        .content {
            padding: 40px;
        }

        .search-box {
            position: relative;
            margin-bottom: 30px;
        }

            .search-box input {
                width: 100%;
                padding: 16px 20px 16px 50px;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 1rem;
                transition: all 0.3s ease;
            }

                .search-box input:focus {
                    outline: none;
                    border-color: #4f46e5;
                    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
                }

            .search-box i {
                position: absolute;
                left: 18px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
            }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #4f46e5;
        }

            .stat-card h3 {
                color: #4f46e5;
                font-size: 2.5rem;
                margin-bottom: 5px;
            }

            .stat-card p {
                color: #6b7280;
                font-size: 0.9rem;
            }

        .file-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .file-header {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            padding: 20px;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
        }

        .file-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            padding: 20px;
            align-items: center;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
        }

            .file-item:hover {
                background: #f8fafc;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            }

        .file-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

            .file-icon.pdf {
                background: #ef4444;
            }

            .file-icon.txt {
                background: #10b981;
            }

            .file-icon.img {
                background: #f59e0b;
            }

            .file-icon.docx {
                background: #3b82f6;
            }

            .file-icon.xlsx {
                background: #10b981;
            }

            .file-icon.pptx {
                background: #f59e0b;
            }

            .file-icon.default {
                background: #6b7280;
            }

        .file-details h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #111827;
        }

        .file-details .file-type {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .file-size, .file-date {
            color: #6b7280;
        }

        .file-actions a {
            background: #4f46e5;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            display: inline-block;
            transition: all 0.3s ease;
        }

            .file-actions a:hover {
                background: #4338ca;
                transform: scale(1.05);
            }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

            .loading i {
                font-size: 2rem;
                margin-bottom: 15px;
                color: #4f46e5;
            }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

            .empty-state i {
                font-size: 4rem;
                margin-bottom: 20px;
                color: #9ca3af;
            }

        @media (max-width: 768px) {
            .file-header, .file-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .file-header {
                display: none;
            }

            .stat-card {
                min-width: 100%;
            }

            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-folder-open"></i> 客户文档中心</h1>
            <p>安全、便捷的文档查看平台</p>
        </div>

        <div class="content">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="搜索文档名称..." onkeyup="filterFiles()">
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalFiles">0</h3>
                    <p>总文档数</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSize">0 MB</h3>
                    <p>总文件大小</p>
                </div>
                <div class="stat-card">
                    <h3 id="lastUpdate">-</h3>
                    <p>最后更新</p>
                </div>
            </div>

            <div class="file-list">
                <div class="file-header">
                    <div>文档名称</div>
                    <div>类型</div>
                    <div>大小</div>
                    <div>最后修改</div>
                </div>
                <div id="fileListContainer">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>正在加载文档列表...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 获取文件图标类名
        function getFileIconClass(fileType) {
            const iconMap = {
                '.pdf': 'pdf fas fa-file-pdf',
                '.txt': 'txt fas fa-file-alt',
                '.jpg': 'img fas fa-file-image',
                '.jpeg': 'img fas fa-file-image',
                '.png': 'img fas fa-file-image',
                '.docx': 'docx fas fa-file-word',
                '.xlsx': 'xlsx fas fa-file-excel',
                '.pptx': 'pptx fas fa-file-powerpoint',
                'default': 'default fas fa-file'
            };

            return iconMap[fileType] || iconMap.default;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 加载文档列表
        async function loadDocuments() {
            try {
                const response = await fetch('/api/Documents/list');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const documents = await response.json();
                displayDocuments(documents);
                updateStats(documents);
            } catch (error) {
                console.error('加载文档失败:', error);
                document.getElementById('fileListContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>无法加载文档列表</h3>
                        <p>请检查网络连接或联系管理员</p>
                        <button onclick="loadDocuments()" style="margin-top: 20px; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-redo"></i> 重新加载
                        </button>
                    </div>
                `;
            }
        }

        // 显示文档列表
        function displayDocuments(documents) {
            const container = document.getElementById('fileListContainer');

            if (!documents || documents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>暂无文档</h3>
                        <p>文档目录为空，请联系管理员上传文档</p>
                    </div>
                `;
                return;
            }

            let html = '';
            documents.forEach(doc => {
                const iconClass = getFileIconClass(doc.fileType);
                const size = formatFileSize(doc.size);
                const date = formatDate(doc.lastModified);
                const fileTypeName = doc.fileType.replace('.', '').toUpperCase();

                // 根据文件类型决定打开方式
                const openUrl = doc.fileType === '.txt'
                    ? `/api/Documents/preview/${encodeURIComponent(doc.name)}`
                    : `/api/Documents/download/${encodeURIComponent(doc.name)}`;

                html += `
                    <div class="file-item" data-name="${doc.name.toLowerCase()}">
                        <div class="file-name">
                            <div class="file-icon ${iconClass.split(' ')[0]}">
                                <i class="${iconClass.split(' ')[1]}"></i>
                            </div>
                            <div class="file-details">
                                <h4>${doc.name}</h4>
                                <div class="file-type">${fileTypeName} 文件</div>
                            </div>
                        </div>
                        <div class="file-type">${fileTypeName}</div>
                        <div class="file-size">${size}</div>
                        <div class="file-date">${date}</div>
                        <div class="file-actions">
                            <a href="${openUrl}" target="_blank" onclick="trackDownload('${doc.name}')">
                                <i class="fas fa-external-link-alt"></i> 打开
                            </a>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 更新统计信息
        function updateStats(documents) {
            const totalFiles = documents.length;
            const totalSize = documents.reduce((sum, doc) => sum + doc.size, 0);
            const lastUpdate = documents.length > 0
                ? new Date(Math.max(...documents.map(d => new Date(d.lastModified))))
                : null;

            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);

            if (lastUpdate) {
                document.getElementById('lastUpdate').textContent = formatDate(lastUpdate);
            }
        }

        // 过滤文件
        function filterFiles() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toLowerCase();
            const fileItems = document.querySelectorAll('.file-item');

            fileItems.forEach(item => {
                const fileName = item.getAttribute('data-name');
                if (fileName.includes(filter)) {
                    item.style.display = 'grid';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 跟踪下载（可扩展用于统计）
        function trackDownload(fileName) {
            console.log(`用户打开了文件: ${fileName}`);
            // 这里可以添加统计代码，比如发送到Google Analytics
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadDocuments();

            // 每5分钟自动刷新一次（可选）
            setInterval(loadDocuments, 5 * 60 * 1000);
        });
    </script>
</body>
</html>-->
